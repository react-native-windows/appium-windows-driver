"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.DEFAULT_WAD_PORT = exports.DEFAULT_WAD_HOST = exports.WinAppDriver = void 0;

require("source-map-support/register");

var _events = _interopRequireDefault(require("events"));

var _appiumBaseDriver = require("appium-base-driver");

var _logger = _interopRequireDefault(require("./logger"));

var _teen_process = require("teen_process");

var _installer = require("./installer");

var _asyncbox = require("asyncbox");

var _child_process = _interopRequireDefault(require("child_process"));

var _bluebird = _interopRequireDefault(require("bluebird"));

const REQUIRED_PARAMS = [];
const DEFAULT_WAD_HOST = '127.0.0.1';
exports.DEFAULT_WAD_HOST = DEFAULT_WAD_HOST;
const DEFAULT_WAD_PORT = 4724;
exports.DEFAULT_WAD_PORT = DEFAULT_WAD_PORT;
const DEFAULT_CREATE_SESSION_TIMEOUT_MS = 20000;

class WinAppDriver extends _events.default.EventEmitter {
  constructor(opts = {}) {
    const {
      host,
      port,
      createSessionTimeout
    } = opts;
    super();

    for (let req of REQUIRED_PARAMS) {
      if (!opts || !opts[req]) {
        throw new Error(`Option '${req}' is required!`);
      }

      this[req] = opts[req];
    }

    this.proxyHost = host || DEFAULT_WAD_HOST;
    this.proxyPort = port || DEFAULT_WAD_PORT;
    this.createSessionTimeout = createSessionTimeout || DEFAULT_CREATE_SESSION_TIMEOUT_MS;
    this.proc = null;
    this.state = WinAppDriver.STATE_STOPPED;
    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.proxyHost,
      port: this.proxyPort
    });
  }

  async start() {
    if (!(await (0, _installer.verifyWAD)())) {
      throw new Error('Could not verify WinAppDriver install; re-run install');
    }

    this.changeState(WinAppDriver.STATE_STARTING);
    let args = [this.proxyPort + '/wd/hub'];

    const startDetector = stdout => {
      return stdout.indexOf('listening for requests') !== -1;
    };

    let processIsAlive = false;

    try {
      await this.killAll();
      this.proc = new _teen_process.SubProcess(_installer.WAD_INSTALL_PATH, args, {
        encoding: 'ucs2'
      });
      processIsAlive = true;

      for (let stream of ['STDOUT', 'STDERR']) {
        this.proc.on(`lines-${stream.toLowerCase()}`, lines => {
          for (let l of lines) {
            _logger.default.info(`[${stream}] ${l.trim()}`);
          }
        });
      }

      this.proc.on('exit', (code, signal) => {
        processIsAlive = false;

        if (this.state !== WinAppDriver.STATE_STOPPED && this.state !== WinAppDriver.STATE_STOPPING) {
          let msg = `WinAppDriver exited unexpectedly with code ${code}, ` + `signal ${signal}`;

          _logger.default.error(msg);

          this.changeState(WinAppDriver.STATE_STOPPED);
        }
      });

      _logger.default.info(`Spawning WinAppDriver with: ${args.join(' ')}`);

      await this.proc.start(startDetector);
      await this.waitForOnline();
    } catch (e) {
      this.emit(WinAppDriver.EVENT_ERROR, e);

      if (processIsAlive) {
        await this.proc.stop();
      }

      _logger.default.errorAndThrow(e);
    }
  }

  sessionId() {
    if (this.state !== WinAppDriver.STATE_ONLINE) {
      return null;
    }

    return this.jwproxy.sessionId;
  }

  async waitForOnline() {
    let winappdriverStopped = false;
    await (0, _asyncbox.retryInterval)(20, 200, async () => {
      if ([WinAppDriver.STATE_STOPPED, WinAppDriver.STATE_ONLINE].indexOf(this.state) >= 0) {
        winappdriverStopped = this.state === WinAppDriver.STATE_STOPPED;
        return;
      }

      if (await this.getStatus()) {
        this.changeState(WinAppDriver.STATE_ONLINE);
      }
    });

    if (winappdriverStopped) {
      throw new Error('WinAppDriver crashed during startup.');
    }
  }

  async getStatus() {
    const resBlock = await this.jwproxy.proxy('/status', 'GET');

    if (resBlock[0].statusCode === 200) {
      _logger.default.info(`Status call returned 200. we're online and ready to run tests`);

      return true;
    }

    return false;
  }

  async startSession(caps) {
    const createSessionTimeout = caps.createSessionTimeout || this.createSessionTimeout;

    _logger.default.debug(`Starting WinAppDriver session. Will timeout in '${createSessionTimeout}' ms.`);

    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    let retryIteration = 0;
    let lastError;

    const condFn = async () => {
      lastError = null;

      try {
        retryIteration++;
        await this.jwproxy.command('/session', 'POST', {
          desiredCapabilities: caps
        });
        return true;
      } catch (error) {
        lastError = error;

        _logger.default.warn(`Could not start WinAppDriver session error = '${error.message}', attempt = '${retryIteration}' from '${this.createSessionRetry}'`);

        return false;
      }
    };

    try {
      await (0, _asyncbox.waitForCondition)(condFn, {
        waitMs: createSessionTimeout,
        intervalMs: 500
      });
    } catch (timeoutError) {
      _logger.default.debug(`timeoutError was ${timeoutError.message}`);

      if (lastError) {
        throw lastError;
      }

      throw new Error(`Could not start WinAppDriver session within ${createSessionTimeout} ms.`);
    }
  }

  async stop(emitStates = true) {
    if (emitStates) {
      this.changeState(WinAppDriver.STATE_STOPPING);
    }

    try {
      if (this.proc) {
        await this.proc.stop();
      }

      if (emitStates) {
        this.changeState(WinAppDriver.STATE_STOPPED);
      }
    } catch (e) {
      _logger.default.error(e);
    }
  }

  changeState(state) {
    this.state = state;

    _logger.default.debug(`WinAppDriver changed state to '${state}'`);

    this.emit(WinAppDriver.EVENT_CHANGED, {
      state
    });
  }

  async sendCommand(url, method, body) {
    return await this.jwproxy.command(url, method, body);
  }

  async proxyReq(req, res) {
    return await this.jwproxy.proxyReqRes(req, res);
  }

  async killAll() {
    let cmd;
    cmd = 'FOR /F "usebackq tokens=5" %a in (`netstat -nao ^| ' + 'findstr /R /C:"' + this.proxyPort + ' "`) do (' + 'FOR /F "usebackq" %b in (`TASKLIST /FI "PID eq %a" ^| ' + 'findstr /I winappdriver.exe`) do (IF NOT %b=="" TASKKILL ' + '/F /PID %a))';

    _logger.default.info(`Killing any old WinAppDrivers on same port, running: ${cmd}`);

    try {
      await _bluebird.default.promisify(_child_process.default.exec)(cmd);

      _logger.default.info('Successfully cleaned up old WinAppDrivers');
    } catch (err) {
      _logger.default.info('No old WinAppDrivers seemed to exist');
    }
  }

  async deleteSession() {
    _logger.default.debug('Deleting WinAppDriver server session');

    try {
      await this.jwproxy.command('/', 'DELETE');
    } catch (err) {
      _logger.default.warn(`Did not get confirmation WinAppDriver deleteSession worked; ` + `Error was: ${err}`);
    }
  }

}

exports.WinAppDriver = WinAppDriver;
WinAppDriver.EVENT_ERROR = 'winappdriver_error';
WinAppDriver.EVENT_CHANGED = 'stateChanged';
WinAppDriver.STATE_STOPPED = 'stopped';
WinAppDriver.STATE_STARTING = 'starting';
WinAppDriver.STATE_ONLINE = 'online';
WinAppDriver.STATE_STOPPING = 'stopping';
var _default = WinAppDriver;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93aW5hcHBkcml2ZXIuanMiXSwibmFtZXMiOlsiUkVRVUlSRURfUEFSQU1TIiwiREVGQVVMVF9XQURfSE9TVCIsIkRFRkFVTFRfV0FEX1BPUlQiLCJERUZBVUxUX0NSRUFURV9TRVNTSU9OX1RJTUVPVVRfTVMiLCJXaW5BcHBEcml2ZXIiLCJldmVudHMiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJob3N0IiwicG9ydCIsImNyZWF0ZVNlc3Npb25UaW1lb3V0IiwicmVxIiwiRXJyb3IiLCJwcm94eUhvc3QiLCJwcm94eVBvcnQiLCJwcm9jIiwic3RhdGUiLCJTVEFURV9TVE9QUEVEIiwiandwcm94eSIsIkpXUHJveHkiLCJzZXJ2ZXIiLCJzdGFydCIsImNoYW5nZVN0YXRlIiwiU1RBVEVfU1RBUlRJTkciLCJhcmdzIiwic3RhcnREZXRlY3RvciIsInN0ZG91dCIsImluZGV4T2YiLCJwcm9jZXNzSXNBbGl2ZSIsImtpbGxBbGwiLCJTdWJQcm9jZXNzIiwiV0FEX0lOU1RBTExfUEFUSCIsImVuY29kaW5nIiwic3RyZWFtIiwib24iLCJ0b0xvd2VyQ2FzZSIsImxpbmVzIiwibCIsImxvZyIsImluZm8iLCJ0cmltIiwiY29kZSIsInNpZ25hbCIsIlNUQVRFX1NUT1BQSU5HIiwibXNnIiwiZXJyb3IiLCJqb2luIiwid2FpdEZvck9ubGluZSIsImUiLCJlbWl0IiwiRVZFTlRfRVJST1IiLCJzdG9wIiwiZXJyb3JBbmRUaHJvdyIsInNlc3Npb25JZCIsIlNUQVRFX09OTElORSIsIndpbmFwcGRyaXZlclN0b3BwZWQiLCJnZXRTdGF0dXMiLCJyZXNCbG9jayIsInByb3h5Iiwic3RhdHVzQ29kZSIsInN0YXJ0U2Vzc2lvbiIsImNhcHMiLCJkZWJ1ZyIsInByb3h5UmVxUmVzIiwiYmluZCIsInJldHJ5SXRlcmF0aW9uIiwibGFzdEVycm9yIiwiY29uZEZuIiwiY29tbWFuZCIsImRlc2lyZWRDYXBhYmlsaXRpZXMiLCJ3YXJuIiwibWVzc2FnZSIsImNyZWF0ZVNlc3Npb25SZXRyeSIsIndhaXRNcyIsImludGVydmFsTXMiLCJ0aW1lb3V0RXJyb3IiLCJlbWl0U3RhdGVzIiwiRVZFTlRfQ0hBTkdFRCIsInNlbmRDb21tYW5kIiwidXJsIiwibWV0aG9kIiwiYm9keSIsInByb3h5UmVxIiwicmVzIiwiY21kIiwiQiIsInByb21pc2lmeSIsImNwIiwiZXhlYyIsImVyciIsImRlbGV0ZVNlc3Npb24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsZUFBZSxHQUFHLEVBQXhCO0FBQ0EsTUFBTUMsZ0JBQWdCLEdBQUcsV0FBekI7O0FBQ0EsTUFBTUMsZ0JBQWdCLEdBQUcsSUFBekI7O0FBQ0EsTUFBTUMsaUNBQWlDLEdBQUcsS0FBMUM7O0FBRUEsTUFBTUMsWUFBTixTQUEyQkMsZ0JBQU9DLFlBQWxDLENBQStDO0FBQzdDQyxFQUFBQSxXQUFXLENBQUVDLElBQUksR0FBRyxFQUFULEVBQWE7QUFDdEIsVUFBTTtBQUFDQyxNQUFBQSxJQUFEO0FBQU9DLE1BQUFBLElBQVA7QUFBYUMsTUFBQUE7QUFBYixRQUFxQ0gsSUFBM0M7QUFDQTs7QUFFQSxTQUFLLElBQUlJLEdBQVQsSUFBZ0JaLGVBQWhCLEVBQWlDO0FBQy9CLFVBQUksQ0FBQ1EsSUFBRCxJQUFTLENBQUNBLElBQUksQ0FBQ0ksR0FBRCxDQUFsQixFQUF5QjtBQUN2QixjQUFNLElBQUlDLEtBQUosQ0FBVyxXQUFVRCxHQUFJLGdCQUF6QixDQUFOO0FBQ0Q7O0FBQ0QsV0FBS0EsR0FBTCxJQUFZSixJQUFJLENBQUNJLEdBQUQsQ0FBaEI7QUFDRDs7QUFFRCxTQUFLRSxTQUFMLEdBQWlCTCxJQUFJLElBQUlSLGdCQUF6QjtBQUNBLFNBQUtjLFNBQUwsR0FBaUJMLElBQUksSUFBSVIsZ0JBQXpCO0FBQ0EsU0FBS1Msb0JBQUwsR0FBNEJBLG9CQUFvQixJQUFJUixpQ0FBcEQ7QUFDQSxTQUFLYSxJ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QU47O0FBQ0E5QyxzQkFBSUMsSUFBSixDQUFTLDJDQUFUO0FBQ0QsS0FKRCxDQUlFLE9BQU9rRCxHQUFQLEVBQVk7QUFDWm5ELHNCQUFJQyxJQUFKLENBQVMsc0NBQVQ7QUFDRDtBQUNGOztBQUVELFFBQU1tRCxhQUFOLEdBQXVCO0FBQ3JCcEQsb0JBQUl3QixLQUFKLENBQVUsc0NBQVY7O0FBR0EsUUFBSTtBQUNGLFlBQU0sS0FBSzVDLE9BQUwsQ0FBYWtELE9BQWIsQ0FBcUIsR0FBckIsRUFBMEIsUUFBMUIsQ0FBTjtBQUNELEtBRkQsQ0FFRSxPQUFPcUIsR0FBUCxFQUFZO0FBQ1puRCxzQkFBSWdDLElBQUosQ0FBVSw4REFBRCxHQUNOLGNBQWFtQixHQUFJLEVBRHBCO0FBRUQ7QUFDRjs7QUFwTjRDOzs7QUF1Ti9DdEYsWUFBWSxDQUFDK0MsV0FBYixHQUEyQixvQkFBM0I7QUFDQS9DLFlBQVksQ0FBQzBFLGFBQWIsR0FBNkIsY0FBN0I7QUFDQTFFLFlBQVksQ0FBQ2MsYUFBYixHQUE2QixTQUE3QjtBQUNBZCxZQUFZLENBQUNvQixjQUFiLEdBQThCLFVBQTlCO0FBQ0FwQixZQUFZLENBQUNtRCxZQUFiLEdBQTRCLFFBQTVCO0FBQ0FuRCxZQUFZLENBQUN3QyxjQUFiLEdBQThCLFVBQTlCO2VBR2V4QyxZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV2ZW50cyBmcm9tICdldmVudHMnO1xyXG5pbXBvcnQgeyBKV1Byb3h5IH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcclxuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XHJcbmltcG9ydCB7IFN1YlByb2Nlc3MgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xyXG5pbXBvcnQgeyBXQURfSU5TVEFMTF9QQVRILCB2ZXJpZnlXQUQgfSBmcm9tICcuL2luc3RhbGxlcic7XHJcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwsIHdhaXRGb3JDb25kaXRpb24gfSBmcm9tICdhc3luY2JveCc7XHJcbmltcG9ydCBjcCBmcm9tICdjaGlsZF9wcm9jZXNzJztcclxuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xyXG5cclxuY29uc3QgUkVRVUlSRURfUEFSQU1TID0gW107IC8vIFhYWUQgMS01LTIwMTg6IHJlbW92ZWQgYXBwIGZyb20gcmVxdWlyZWQgcGFyYW1zIGJlY2F1c2UgeW91IGNhbiBhbHRlcm5hdGl2ZWx5IHVzZSBhcHBUb3BMZXZlbFdpbmRvd1xyXG5jb25zdCBERUZBVUxUX1dBRF9IT1NUID0gJzEyNy4wLjAuMSc7XHJcbmNvbnN0IERFRkFVTFRfV0FEX1BPUlQgPSA0NzI0OyAvLyBzaG91bGQgYmUgbm9uLTQ3MjMgdG8gYXZvaWQgY29uZmxpY3Qgb24gdGhlIHNhbWUgYm94O1xyXG5jb25zdCBERUZBVUxUX0NSRUFURV9TRVNTSU9OX1RJTUVPVVRfTVMgPSAyMDAwMDsgLy8gcmV0cnkgc3RhcnQgc2Vzc2lvbiBjcmVhdGlvbiBkdXJpbmcgdGhlIHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzXHJcblxyXG5jbGFzcyBXaW5BcHBEcml2ZXIgZXh0ZW5kcyBldmVudHMuRXZlbnRFbWl0dGVyIHtcclxuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XHJcbiAgICBjb25zdCB7aG9zdCwgcG9ydCwgY3JlYXRlU2Vzc2lvblRpbWVvdXR9ID0gb3B0cztcclxuICAgIHN1cGVyKCk7XHJcblxyXG4gICAgZm9yIChsZXQgcmVxIG9mIFJFUVVJUkVEX1BBUkFNUykge1xyXG4gICAgICBpZiAoIW9wdHMgfHwgIW9wdHNbcmVxXSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgT3B0aW9uICcke3JlcX0nIGlzIHJlcXVpcmVkIWApO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXNbcmVxXSA9IG9wdHNbcmVxXTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLnByb3h5SG9zdCA9IGhvc3QgfHwgREVGQVVMVF9XQURfSE9TVDtcclxuICAgIHRoaXMucHJveHlQb3J0ID0gcG9ydCB8fCBERUZBVUxUX1dBRF9QT1JUO1xyXG4gICAgdGhpcy5jcmVhdGVTZXNzaW9uVGltZW91dCA9IGNyZWF0ZVNlc3Npb25UaW1lb3V0IHx8IERFRkFVTFRfQ1JFQVRFX1NFU1NJT05fVElNRU9VVF9NUztcclxuICAgIHRoaXMucHJvYyA9IG51bGw7XHJcbiAgICB0aGlzLnN0YXRlID0gV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQRUQ7XHJcbiAgICB0aGlzLmp3cHJveHkgPSBuZXcgSldQcm94eSh7c2VydmVyOiB0aGlzLnByb3h5SG9zdCwgcG9ydDogdGhpcy5wcm94eVBvcnR9KTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHN0YXJ0ICgpIHtcclxuICAgIGlmICghYXdhaXQgdmVyaWZ5V0FEKCkpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgdmVyaWZ5IFdpbkFwcERyaXZlciBpbnN0YWxsOyByZS1ydW4gaW5zdGFsbCcpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuY2hhbmdlU3RhdGUoV2luQXBwRHJpdmVyLlNUQVRFX1NUQVJUSU5HKTtcclxuXHJcbiAgICAvLyBYWFhZRCBUT0RPOiB3b3VsZCBiZSBiZXR0ZXIgaWYgV2luQXBwRHJpdmVyIGRpZG4ndCByZXF1aXJlIHBhc3NpbmcgaW4gL3dkL2h1YiBhcyBhIHBhcmFtXHJcbiAgICBsZXQgYXJncyA9IFt0aGlzLnByb3h5UG9ydCArICcvd2QvaHViJ107XHJcblxyXG4gICAgY29uc3Qgc3RhcnREZXRlY3RvciA9IChzdGRvdXQpID0+IHtcclxuICAgICAgcmV0dXJuIHN0ZG91dC5pbmRleE9mKCdsaXN0ZW5pbmcgZm9yIHJlcXVlc3RzJykgIT09IC0xO1xyXG4gICAgfTtcclxuXHJcbiAgICBsZXQgcHJvY2Vzc0lzQWxpdmUgPSBmYWxzZTtcclxuICAgIHRyeSB7XHJcbiAgICAgIGF3YWl0IHRoaXMua2lsbEFsbCgpO1xyXG5cclxuICAgICAgLy8gc2V0IHVwIG91ciBzdWJwcm9jZXNzIG9iamVjdFxyXG4gICAgICB0aGlzLnByb2MgPSBuZXcgU3ViUHJvY2VzcyhXQURfSU5TVEFMTF9QQVRILCBhcmdzLCB7XHJcbiAgICAgICAgZW5jb2Rpbmc6ICd1Y3MyJ1xyXG4gICAgICB9KTtcclxuICAgICAgcHJvY2Vzc0lzQWxpdmUgPSB0cnVlO1xyXG5cclxuICAgICAgLy8gaGFuZGxlIGxvZyBvdXRwdXRcclxuICAgICAgZm9yIChsZXQgc3RyZWFtIG9mIFsnU1RET1VUJywgJ1NUREVSUiddKSB7XHJcbiAgICAgICAgdGhpcy5wcm9jLm9uKGBsaW5lcy0ke3N0cmVhbS50b0xvd2VyQ2FzZSgpfWAsIChsaW5lcykgPT4ge1xyXG4gICAgICAgICAgZm9yIChsZXQgbCBvZiBsaW5lcykge1xyXG4gICAgICAgICAgICBsb2cuaW5mbyhgWyR7c3RyZWFtfV0gJHtsLnRyaW0oKX1gKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gaGFuZGxlIG91dC1vZi1ib3VuZCBleGl0IGJ5IHNpbXBseSBlbWl0dGluZyBhIHN0b3BwZWQgc3RhdGVcclxuICAgICAgdGhpcy5wcm9jLm9uKCdleGl0JywgKGNvZGUsIHNpZ25hbCkgPT4ge1xyXG4gICAgICAgIHByb2Nlc3NJc0FsaXZlID0gZmFsc2U7XHJcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09IFdpbkFwcERyaXZlci5TVEFURV9TVE9QUEVEICYmXHJcbiAgICAgICAgICAgIHRoaXMuc3RhdGUgIT09IFdpbkFwcERyaXZlci5TVEFURV9TVE9QUElORykge1xyXG4gICAgICAgICAgbGV0IG1zZyA9IGBXaW5BcHBEcml2ZXIgZXhpdGVkIHVuZXhwZWN0ZWRseSB3aXRoIGNvZGUgJHtjb2RlfSwgYCArXHJcbiAgICAgICAgICAgICAgICAgICAgYHNpZ25hbCAke3NpZ25hbH1gO1xyXG4gICAgICAgICAgbG9nLmVycm9yKG1zZyk7XHJcbiAgICAgICAgICB0aGlzLmNoYW5nZVN0YXRlKFdpbkFwcERyaXZlci5TVEFURV9TVE9QUEVEKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICBsb2cuaW5mbyhgU3Bhd25pbmcgV2luQXBwRHJpdmVyIHdpdGg6ICR7YXJncy5qb2luKCcgJyl9YCk7XHJcblxyXG4gICAgICAvLyBzdGFydCBzdWJwcm9jIGFuZCB3YWl0IGZvciBzdGFydERldGVjdG9yXHJcbiAgICAgIGF3YWl0IHRoaXMucHJvYy5zdGFydChzdGFydERldGVjdG9yKTtcclxuICAgICAgYXdhaXQgdGhpcy53YWl0Rm9yT25saW5lKCk7XHJcblxyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICB0aGlzLmVtaXQoV2luQXBwRHJpdmVyLkVWRU5UX0VSUk9SLCBlKTtcclxuICAgICAgLy8ganVzdCBiZWNhdXNlIHdlIGhhZCBhbiBlcnJvciBkb2Vzbid0IG1lYW4gdGhlIFdpbkFwcERyaXZlciBwcm9jZXNzXHJcbiAgICAgIC8vIGZpbmlzaGVkOyB3ZSBzaG91bGQgY2xlYW4gdXAgaWYgbmVjZXNzYXJ5XHJcbiAgICAgIGlmIChwcm9jZXNzSXNBbGl2ZSkge1xyXG4gICAgICAgIGF3YWl0IHRoaXMucHJvYy5zdG9wKCk7XHJcbiAgICAgIH1cclxuICAgICAgbG9nLmVycm9yQW5kVGhyb3coZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzZXNzaW9uSWQgKCkge1xyXG4gICAgaWYgKHRoaXMuc3RhdGUgIT09IFdpbkFwcERyaXZlci5TVEFURV9PTkxJTkUpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuandwcm94eS5zZXNzaW9uSWQ7XHJcbiAgfVxyXG5cclxuICBhc3luYyB3YWl0Rm9yT25saW5lICgpIHtcclxuXHJcbiAgICAvLyB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSBXQUQgaGFzbid0IGNyYXNoZWRcclxuICAgIGxldCB3aW5hcHBkcml2ZXJTdG9wcGVkID0gZmFsc2U7XHJcbiAgICBhd2FpdCByZXRyeUludGVydmFsKDIwLCAyMDAsIGFzeW5jICgpID0+IHtcclxuICAgICAgaWYgKFtXaW5BcHBEcml2ZXIuU1RBVEVfU1RPUFBFRCwgV2luQXBwRHJpdmVyLlNUQVRFX09OTElORV0uaW5kZXhPZih0aGlzLnN0YXRlKSA+PSAwKSB7XHJcbiAgICAgICAgLy8gd2UgYXJlIGVpdGhlciBzdG9wcGVkLCBzdG9wcGluZywgb3Igd2UncmUgb25saW5lXHJcbiAgICAgICAgd2luYXBwZHJpdmVyU3RvcHBlZCA9IHRoaXMuc3RhdGUgPT09IFdpbkFwcERyaXZlci5TVEFURV9TVE9QUEVEO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKGF3YWl0IHRoaXMuZ2V0U3RhdHVzKCkpIHtcclxuICAgICAgICB0aGlzLmNoYW5nZVN0YXRlKFdpbkFwcERyaXZlci5TVEFURV9PTkxJTkUpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAod2luYXBwZHJpdmVyU3RvcHBlZCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1dpbkFwcERyaXZlciBjcmFzaGVkIGR1cmluZyBzdGFydHVwLicpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0U3RhdHVzICgpIHtcclxuICAgIGNvbnN0IHJlc0Jsb2NrID0gYXdhaXQgdGhpcy5qd3Byb3h5LnByb3h5KCcvc3RhdHVzJywgJ0dFVCcpO1xyXG4gICAgaWYgKHJlc0Jsb2NrWzBdLnN0YXR1c0NvZGUgPT09IDIwMCkge1xyXG4gICAgICBsb2cuaW5mbyhgU3RhdHVzIGNhbGwgcmV0dXJuZWQgMjAwLiB3ZSdyZSBvbmxpbmUgYW5kIHJlYWR5IHRvIHJ1biB0ZXN0c2ApO1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHN0YXJ0U2Vzc2lvbiAoY2Fwcykge1xyXG5cclxuICAgIGNvbnN0IGNyZWF0ZVNlc3Npb25UaW1lb3V0ID0gY2Fwcy5jcmVhdGVTZXNzaW9uVGltZW91dCB8fCB0aGlzLmNyZWF0ZVNlc3Npb25UaW1lb3V0O1xyXG4gICAgbG9nLmRlYnVnKGBTdGFydGluZyBXaW5BcHBEcml2ZXIgc2Vzc2lvbi4gV2lsbCB0aW1lb3V0IGluICcke2NyZWF0ZVNlc3Npb25UaW1lb3V0fScgbXMuYCk7XHJcbiAgICB0aGlzLnByb3h5UmVxUmVzID0gdGhpcy5qd3Byb3h5LnByb3h5UmVxUmVzLmJpbmQodGhpcy5qd3Byb3h5KTtcclxuICAgIGxldCByZXRyeUl0ZXJhdGlvbiA9IDA7XHJcbiAgICBsZXQgbGFzdEVycm9yO1xyXG5cclxuICAgIGNvbnN0IGNvbmRGbiA9IGFzeW5jICgpID0+IHtcclxuICAgICAgbGFzdEVycm9yID0gbnVsbDtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICByZXRyeUl0ZXJhdGlvbisrO1xyXG4gICAgICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc2Vzc2lvbicsICdQT1NUJywge2Rlc2lyZWRDYXBhYmlsaXRpZXM6IGNhcHN9KTtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICBsYXN0RXJyb3IgPSBlcnJvcjtcclxuICAgICAgICBsb2cud2FybihgQ291bGQgbm90IHN0YXJ0IFdpbkFwcERyaXZlciBzZXNzaW9uIGVycm9yID0gJyR7ZXJyb3IubWVzc2FnZX0nLCBhdHRlbXB0ID0gJyR7cmV0cnlJdGVyYXRpb259JyBmcm9tICcke3RoaXMuY3JlYXRlU2Vzc2lvblJldHJ5fSdgKTtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbihjb25kRm4sIHtcclxuICAgICAgICB3YWl0TXM6IGNyZWF0ZVNlc3Npb25UaW1lb3V0LFxyXG4gICAgICAgIGludGVydmFsTXM6IDUwMFxyXG4gICAgICB9KTtcclxuICAgIH0gY2F0Y2ggKHRpbWVvdXRFcnJvcikge1xyXG4gICAgICBsb2cuZGVidWcoYHRpbWVvdXRFcnJvciB3YXMgJHt0aW1lb3V0RXJyb3IubWVzc2FnZX1gKTtcclxuICAgICAgaWYgKGxhc3RFcnJvcikge1xyXG4gICAgICAgIHRocm93IChsYXN0RXJyb3IpO1xyXG4gICAgICB9XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IHN0YXJ0IFdpbkFwcERyaXZlciBzZXNzaW9uIHdpdGhpbiAke2NyZWF0ZVNlc3Npb25UaW1lb3V0fSBtcy5gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIHN0b3AgKGVtaXRTdGF0ZXMgPSB0cnVlKSB7XHJcbiAgICBpZiAoZW1pdFN0YXRlcykge1xyXG4gICAgICB0aGlzLmNoYW5nZVN0YXRlKFdpbkFwcERyaXZlci5TVEFURV9TVE9QUElORyk7XHJcbiAgICB9XHJcbiAgICB0cnkge1xyXG4gICAgICBpZiAodGhpcy5wcm9jKSB7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5wcm9jLnN0b3AoKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoZW1pdFN0YXRlcykge1xyXG4gICAgICAgIHRoaXMuY2hhbmdlU3RhdGUoV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQRUQpO1xyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgIGxvZy5lcnJvcihlKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNoYW5nZVN0YXRlIChzdGF0ZSkge1xyXG4gICAgdGhpcy5zdGF0ZSA9IHN0YXRlO1xyXG4gICAgbG9nLmRlYnVnKGBXaW5BcHBEcml2ZXIgY2hhbmdlZCBzdGF0ZSB0byAnJHtzdGF0ZX0nYCk7XHJcbiAgICB0aGlzLmVtaXQoV2luQXBwRHJpdmVyLkVWRU5UX0NIQU5HRUQsIHtzdGF0ZX0pO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgc2VuZENvbW1hbmQgKHVybCwgbWV0aG9kLCBib2R5KSB7XHJcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQodXJsLCBtZXRob2QsIGJvZHkpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgcHJveHlSZXEgKHJlcSwgcmVzKSB7XHJcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5qd3Byb3h5LnByb3h5UmVxUmVzKHJlcSwgcmVzKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGtpbGxBbGwgKCkge1xyXG4gICAgbGV0IGNtZDtcclxuICAgIC8vIGpzIGhpbnQgY2Fubm90IGhhbmRsZSBiYWNrdGlja3MsIGV2ZW4gZXNjYXBlZCwgd2l0aGluIHRlbXBsYXRlIGxpdGVyYWxzXHJcbiAgICBjbWQgPSAnRk9SIC9GIFwidXNlYmFja3EgdG9rZW5zPTVcIiAlYSBpbiAoYG5ldHN0YXQgLW5hbyBefCAnICtcclxuICAgICAgICAgICdmaW5kc3RyIC9SIC9DOlwiJyArIHRoaXMucHJveHlQb3J0ICsgJyBcImApIGRvICgnICtcclxuICAgICAgICAgICdGT1IgL0YgXCJ1c2ViYWNrcVwiICViIGluIChgVEFTS0xJU1QgL0ZJIFwiUElEIGVxICVhXCIgXnwgJyArXHJcbiAgICAgICAgICAnZmluZHN0ciAvSSB3aW5hcHBkcml2ZXIuZXhlYCkgZG8gKElGIE5PVCAlYj09XCJcIiBUQVNLS0lMTCAnICtcclxuICAgICAgICAgICcvRiAvUElEICVhKSknO1xyXG4gICAgbG9nLmluZm8oYEtpbGxpbmcgYW55IG9sZCBXaW5BcHBEcml2ZXJzIG9uIHNhbWUgcG9ydCwgcnVubmluZzogJHtjbWR9YCk7XHJcbiAgICB0cnkge1xyXG4gICAgICAvLyB1c2UgY3AuZXhlYyBpbnN0ZWFkIG9mIHRlZW4gcHJvY2VzcyBiZWNhdXNlIG9mIGNyYXp5IHdpbmRvd3MgcXVvdGluZ1xyXG4gICAgICBhd2FpdCAoQi5wcm9taXNpZnkoY3AuZXhlYykpKGNtZCk7XHJcbiAgICAgIGxvZy5pbmZvKCdTdWNjZXNzZnVsbHkgY2xlYW5lZCB1cCBvbGQgV2luQXBwRHJpdmVycycpO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIGxvZy5pbmZvKCdObyBvbGQgV2luQXBwRHJpdmVycyBzZWVtZWQgdG8gZXhpc3QnKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKCkge1xyXG4gICAgbG9nLmRlYnVnKCdEZWxldGluZyBXaW5BcHBEcml2ZXIgc2VydmVyIHNlc3Npb24nKTtcclxuICAgIC8vIHJlbHkgb24gandwcm94eSdzIGludGVsbGlnZW5jZSB0byBrbm93IHdoYXQgd2UncmUgdGFsa2luZyBhYm91dCBhbmRcclxuICAgIC8vIGRlbGV0ZSB0aGUgY3VycmVudCBzZXNzaW9uXHJcbiAgICB0cnkge1xyXG4gICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnLycsICdERUxFVEUnKTtcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICBsb2cud2FybihgRGlkIG5vdCBnZXQgY29uZmlybWF0aW9uIFdpbkFwcERyaXZlciBkZWxldGVTZXNzaW9uIHdvcmtlZDsgYCArXHJcbiAgICAgICAgYEVycm9yIHdhczogJHtlcnJ9YCk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5XaW5BcHBEcml2ZXIuRVZFTlRfRVJST1IgPSAnd2luYXBwZHJpdmVyX2Vycm9yJztcclxuV2luQXBwRHJpdmVyLkVWRU5UX0NIQU5HRUQgPSAnc3RhdGVDaGFuZ2VkJztcclxuV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQRUQgPSAnc3RvcHBlZCc7XHJcbldpbkFwcERyaXZlci5TVEFURV9TVEFSVElORyA9ICdzdGFydGluZyc7XHJcbldpbkFwcERyaXZlci5TVEFURV9PTkxJTkUgPSAnb25saW5lJztcclxuV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQSU5HID0gJ3N0b3BwaW5nJztcclxuXHJcbmV4cG9ydCB7IFdpbkFwcERyaXZlciwgREVGQVVMVF9XQURfSE9TVCwgREVGQVVMVF9XQURfUE9SVCB9O1xyXG5leHBvcnQgZGVmYXVsdCBXaW5BcHBEcml2ZXI7XHJcbiJdLCJmaWxlIjoibGliL3dpbmFwcGRyaXZlci5qcyIsInNvdXJjZVJvb3QiOiIuLlxcLi4ifQ==
